/*
 *  cdg.js - a CD+G player for the web, based upon CD+Graphics Magic HTML5 CD+G Player
 *  (http://cdgmagic.sourceforge.net/html5_cdgplayer/). Visit project for full license
 *  information and documentation: https://github.com/willprescott/cdg.js
 */

define("cdg",[],function(){"use strict";function e(e,r){function t(){H=0,A=0,f(),u(0),c()}function a(){return H}function o(){if((L||P)&&(p.style.backgroundColor=i(A),L=!1),P)s(),P=!1,c(),O.putImageData(m,0,0);else for(var e=O,r=m,t=S,a=C.FONT_WIDTH,o=C.FONT_HEIGHT,n=0,d=1;d<=16;++d){n=d*C.NUM_X_FONTS+1;for(var f=1;f<=48;++f)t[n]&&(l(f,d),e.putImageData(r,0,0,(f-1)*a,(d-1)*o,a,o),t[n]=0),++n}}function n(e,r){for(var t=H;t<r;t++){var a=24*t;if((63&e.charCodeAt(a))==C.TV_GRAPHICS){var o=e.slice(a,a+24);switch(63&o.charCodeAt(1)){case C.MEMORY_PRESET:T(o);break;case C.BORDER_PRESET:_(o);break;case C.LOAD_CLUT_LO:case C.LOAD_CLUT_HI:E(o);break;case C.COPY_FONT:case C.XOR_FONT:h(o);break;case C.SCROLL_PRESET:case C.SCROLL_COPY:F(o)}}}H=r}function i(e){return"rgb("+(g[e]>>16&255)+","+(g[e]>>8&255)+","+(g[e]>>0&255)+")"}function d(e){var r=e;return r|=e<<4,r|=e<<8,r|=e<<12,r|=e<<16,r|=e<<20}function c(){for(var e=0;e<900;e++)S[e]=0}function f(){for(var e=C.PALETTE_ENTRIES,r=0;r<e;r++)g[r]=0}function u(e){for(var r=N,t=r.length,a=d(e),o=0;o<t;o++)r[o]=a;P=!0}function s(){for(var e=m.data,r=g,t=N,a=C.VISIBLE_HEIGHT,o=601,n=0,i=0,d=0,c=0;c<a;++c){for(var f=0;f<48;++f)d=t[o++],i=r[d>>0&15],e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=i>>0&255,e[n++]=255,i=r[d>>4&15],e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=i>>0&255,e[n++]=255,i=r[d>>8&15],e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=i>>0&255,e[n++]=255,i=r[d>>12&15],e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=i>>0&255,e[n++]=255,i=r[d>>16&15],e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=i>>0&255,e[n++]=255,i=r[d>>20&15],e[n++]=i>>16&255,e[n++]=i>>8&255,e[n++]=i>>0&255,e[n++]=255;o+=2}}function l(e,r){var t=m.data,a=g,o=N,n=r*C.NUM_X_FONTS*C.FONT_HEIGHT+e,i=C.NUM_X_FONTS,d=n+C.NUM_X_FONTS*C.FONT_HEIGHT,c=(r-1)*C.FONT_HEIGHT*C.VISIBLE_WIDTH;c+=(e-1)*C.FONT_WIDTH,c*=4;for(var f=4*(C.VISIBLE_WIDTH-C.FONT_WIDTH),u=0,s=0;n<d;)s=o[n],u=a[s>>0&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>4&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>8&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>12&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>16&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,u=a[s>>20&15],t[c++]=u>>16&255,t[c++]=u>>8&255,t[c++]=u>>0&255,t[c++]=255,n+=i,c+=f}function _(e){var r=63&e.charCodeAt(4);g[r]!=g[A]&&(L=!0),A=r}function T(e){u(63&e.charCodeAt(4))}function E(e){for(var r=g,t=8*(1&e.charCodeAt(1)),a=0;a<8;a++){var o=a+t,n=0,i=0;i=(60&e.charCodeAt(2*a+4))>>2,n|=17*i<<16,i=(3&e.charCodeAt(2*a+4))<<2|(48&e.charCodeAt(2*a+5))>>4,n|=17*i<<8,i=15&e.charCodeAt(2*a+5),n|=17*i<<0,n!=r[o]&&(r[o]=n,P=!0,o==A&&(L=!0))}}function h(e){var r=N,t=S,a=(48&e.charCodeAt(4))>>2|(48&e.charCodeAt(5))>>4,o=32&e.charCodeAt(1);if(3>>a){var n=63&e.charCodeAt(7),i=31&e.charCodeAt(6);if(n<=49&&i<=17){for(var d=600*i+n,c=[15&e.charCodeAt(4),15&e.charCodeAt(5)],f=0,u=0,s=0;s<12;s++){var l=50*s+d;f=e.charCodeAt(s+8),u=c[f>>5&1]<<0,u|=c[f>>4&1]<<4,u|=c[f>>3&1]<<8,u|=c[f>>2&1]<<12,u|=c[f>>1&1]<<16,u|=c[f>>0&1]<<20,o?r[l]^=u:r[l]=u}t[50*i+n]=1}}}function F(e){var r,t=(8&e.charCodeAt(1))>>3,a=15&e.charCodeAt(4);(r=(48&e.charCodeAt(5))>>4)&&v(r,t,a),(r=(48&e.charCodeAt(6))>>4)&&I(r,t,a),P=!0}function v(e,r,t){var a,o,n,i=0,c=d(t),f=N;if(2==e)for(o=0;o<10800;o+=50){for(n=o,i=f[n],a=n+1;a<n+50;a++)f[a-1]=f[a];f[n+49]=r?i:c}else if(1==e)for(o=0;o<10800;o+=50){for(n=o,i=f[n+49],a=n+48;a>=n;a--)f[a+1]=f[a];f[n]=r?i:c}}function I(e,r,t){var a,o,n=C.NUM_X_FONTS*C.FONT_HEIGHT,i=new Array(n),c=d(t),f=N;if(2==e){for(a=0,o=0;o<n;o++)i[a++]=f[o];for(a=0,o=n;o<10800;o++)f[a++]=f[o];if(a=204*C.NUM_X_FONTS,r)for(o=0;o<n;o++)f[a++]=i[o];else for(o=0;o<n;o++)f[a++]=c}else if(1==e){for(a=0,o=10200;o<10800;o++)i[a++]=f[o];for(o=10199;o>0;o--)f[o+n]=f[o];if(r)for(o=0;o<n;o++)f[o]=i[o];else for(o=0;o<n;o++)f[o]=c}}var C={VRAM_HEIGHT:216,VISIBLE_WIDTH:288,VISIBLE_HEIGHT:192,FONT_WIDTH:6,FONT_HEIGHT:12,NUM_X_FONTS:50,NUM_Y_FONTS:18,PALETTE_ENTRIES:16,TV_GRAPHICS:9,MEMORY_PRESET:1,BORDER_PRESET:2,LOAD_CLUT_LO:30,LOAD_CLUT_HI:31,COPY_FONT:6,XOR_FONT:38,SCROLL_PRESET:20,SCROLL_COPY:24},p=r,O=e.getContext("2d"),m=O.createImageData(C.VISIBLE_WIDTH,C.VISIBLE_HEIGHT),g=new Array(C.PALETTE_ENTRIES),N=new Array(C.NUM_X_FONTS*C.VRAM_HEIGHT),A=0,H=0,L=!1,P=!1,S=new Array(900);this.get_current_pack=a,this.reset_cdg_state=t,this.redraw_canvas=o,this.decode_packs=n,this.reset_cdg_state()}function r(r,t){function a(){if(v&&4==v.readyState){if(200!=v.status)throw new Error("CDG file failed to load");I=v.responseText,v=null}}function o(){if(E.error){var e=E.error.code?E.error.code:E.error;throw new Error("The audio control fired an error event. Could be: "+e)}}function n(){if(null!=I){var e,r=Math.floor(300*E.currentTime),t=C.get_current_pack();r=r<0?0:r,r<t-300&&(C.reset_cdg_state(),t=0),e=t+6,e=r>e?r:e,e>t&&(C.decode_packs(I,e),C.redraw_canvas())}}function i(){F=setInterval(n,20)}function d(){clearInterval(F)}function c(){E.play()}function f(){E.pause()}function u(){E.pause(),E.currentTime=0}function s(e){if(!e||Array.isArray(e)||"string"!=typeof e&&"object"!=typeof e)throw new Error("No track information specified, nothing to load!");var r,t,a=_.mediaPath,o=_.audioFormat,n=_.cdgFileExtension;if("object"==typeof e){if(!e.audioFilePrefix)throw new Error("No audioFilePrefix property defined, nothing to load!");if(r=e.audioFilePrefix,t=e.cdgFilePrefix?e.cdgFilePrefix:e.audioFilePrefix,e.mediaPath&&(a=e.mediaPath),e.audioFormat){if(!T[e.audioFormat])throw new Error("Unsupported audio format specified");o=e.audioFormat}e.cdgFileExtension&&(n=e.cdgFileExtension)}else r=t=e;return{audioFilePrefix:r,cdgFilePrefix:t,mediaPath:a,audioFormat:o,cdgFileExtension:n}}function l(e){var r=s(e);return d(),C.reset_cdg_state(),C.redraw_canvas(),I=null,v=new XMLHttpRequest,v.onreadystatechange=a,v.open("GET",r.mediaPath+r.cdgFilePrefix+"."+r.cdgFileExtension,!0),v.setRequestHeader("Content-Type","text/html"),v.send(),null==h&&(h=document.createElement("source")),h.type=T[r.audioFormat],h.src=r.mediaPath+r.audioFilePrefix+"."+r.audioFormat,E.appendChild(h),E.load(),this}var _={mediaPath:"",audioFormat:"mp3",cdgFileExtension:"cdg"},T={mp3:'audio/mpeg; codecs="mp3"',ogg:'audio/ogg; codecs="vorbis"'},E=null,h=null,F=null,v=null,I=null,C=null;!function(r,t){if(!r)throw new Error("Required initialisation parameter missing.");var a=document.getElementById(r),n=document.createElement("div"),c=document.createElement("canvas");E=document.createElement("audio"),n.id=r+"-border",n.className="cdg-border",c.id=r+"-canvas",c.width="288",c.height="192",c.className="cdg-canvas",E.id=r+"-audio",E.className="cdg-audio",n.appendChild(c),a.appendChild(n),a.appendChild(E),E.style.width=c.offsetWidth+"px",E.controls=!(t&&0==t.showControls),E.autoplay=!(t&&0==t.autoplay),E.addEventListener("error",o,!0),E.addEventListener("play",i,!0),E.addEventListener("pause",d,!0),E.addEventListener("ended",d,!0),E.addEventListener("abort",d,!0),C=new e(c,n)}(r,t),this.loadTrack=l,this.play=c,this.stop=u,this.pause=f}return{init:function(e,t){return new r(e,t)}}});

//# sourceMappingURL=cdg.js.map
